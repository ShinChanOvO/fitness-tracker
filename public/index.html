<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>å¥èº«è¿½è¸ªå™¨</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <style>
    :root { --bg: #0f0f0f; --bg2: #1a1a1a; --bg3: #252525; --text: #fff; --text2: #a0a0a0; --accent: #00d4aa; --danger: #ff6b6b; --success: #6bcb77; --card: rgba(255,255,255,0.03); --border: rgba(255,255,255,0.08); }
    .theme-light { --bg: #f5f5f7; --bg2: #fff; --bg3: #e8e8ed; --text: #1d1d1f; --text2: #6e6e73; --accent: #00a884; --card: rgba(255,255,255,0.8); --border: rgba(0,0,0,0.08); }
    .theme-ocean { --bg: #0a1628; --bg2: #112240; --bg3: #1a3152; --accent: #64ffda; --card: rgba(100,255,218,0.05); --border: rgba(100,255,218,0.15); }
    .theme-sunset { --bg: #1a0a0a; --bg2: #2d1515; --bg3: #3d1f1f; --accent: #ff6b6b; --card: rgba(255,107,107,0.05); --border: rgba(255,107,107,0.15); }
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { font-family: 'Inter', sans-serif; background: var(--bg); color: var(--text); min-height: 100vh; transition: 0.3s; }
    .app { max-width: 480px; margin: 0 auto; min-height: 100vh; }
    .page { display: none; padding: 20px; padding-bottom: 100px; }
    .page.active { display: block; }
    .auth-page { min-height: 100vh; display: flex; flex-direction: column; justify-content: center; padding: 24px; background: linear-gradient(135deg, var(--bg), var(--bg2)); }
    .logo { text-align: center; margin-bottom: 40px; }
    .logo h1 { font-size: 28px; background: linear-gradient(135deg, var(--accent), #00ffcc); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
    .logo p { color: var(--text2); margin-top: 8px; }
    .form { display: flex; flex-direction: column; gap: 16px; }
    .form input { width: 100%; padding: 16px; background: var(--bg3); border: 1px solid var(--border); border-radius: 12px; color: var(--text); font-size: 16px; outline: none; }
    .form input:focus { border-color: var(--accent); }
    .btn { padding: 16px; border: none; border-radius: 12px; font-size: 16px; font-weight: 600; cursor: pointer; background: var(--accent); color: var(--bg); }
    .switch { text-align: center; margin-top: 20px; color: var(--text2); }
    .switch a { color: var(--accent); text-decoration: none; }
    .header { position: sticky; top: 0; background: var(--bg); padding: 16px 20px; display: flex; justify-content: space-between; align-items: center; z-index: 100; backdrop-filter: blur(12px); }
    .nav { position: fixed; bottom: 0; left: 0; right: 0; background: var(--bg2); border-top: 1px solid var(--border); display: flex; justify-content: space-around; padding: 8px 0; padding-bottom: calc(8px + env(safe-area-inset-bottom)); z-index: 100; }
    .nav-item { flex: 1; display: flex; flex-direction: column; align-items: center; gap: 4px; padding: 8px; color: var(--text2); font-size: 11px; }
    .nav-item.active { color: var(--accent); }
    .card { background: var(--card); border: 1px solid var(--border); border-radius: 16px; padding: 20px; margin-bottom: 12px; }
    .stats-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 12px; margin-bottom: 24px; }
    .stat-card .icon { width: 40px; height: 40px; border-radius: 10px; display: flex; align-items: center; justify-content: center; margin-bottom: 12px; font-size: 20px; }
    .stat-card .value { font-size: 24px; font-weight: 700; }
    .stat-card .label { font-size: 13px; color: var(--text2); }
    .quick-add { display: grid; grid-template-columns: repeat(4, 1fr); gap: 8px; margin-bottom: 24px; }
    .quick-btn { aspect-ratio: 1; border-radius: 16px; background: var(--card); border: 1px solid var(--border); display: flex; flex-direction: column; align-items: center; justify-content: center; gap: 6px; cursor: pointer; }
    .quick-btn span { font-size: 24px; }
    .quick-btn label { font-size: 10px; color: var(--text2); }
    .water-bar { height: 12px; background: var(--bg3); border-radius: 6px; overflow: hidden; margin: 12px 0; }
    .water-fill { height: 100%; background: linear-gradient(90deg, var(--accent), #00ffcc); border-radius: 6px; transition: width 0.3s; }
    .water-btns { display: flex; gap: 8px; }
    .water-btns button { flex: 1; padding: 12px; border-radius: 10px; background: var(--bg3); border: 1px solid var(--border); color: var(--text); cursor: pointer; }
    .water-btns button:hover { border-color: var(--accent); }
    .modal { position: fixed; inset: 0; background: rgba(0,0,0,0.6); display: none; align-items: flex-end; justify-content: center; z-index: 200; }
    .modal.active { display: flex; }
    .modal-content { width: 100%; max-width: 480px; background: var(--bg2); border-radius: 24px 24px 0 0; padding: 24px; animation: slideUp 0.3s; }
    @keyframes slideUp { from { transform: translateY(100%); } }
    .modal-header { display: flex; justify-content: space-between; margin-bottom: 20px; }
    .modal-close { width: 32px; height: 32px; border-radius: 8px; background: var(--bg3); border: none; color: var(--text); cursor: pointer; }
    .field { margin-bottom: 16px; }
    .field label { display: block; font-size: 13px; color: var(--text2); margin-bottom: 8px; }
    .field input, .field select { width: 100%; padding: 14px; background: var(--bg3); border: 1px solid var(--border); border-radius: 12px; color: var(--text); font-size: 16px; }
    .row { display: grid; grid-template-columns: repeat(2, 1fr); gap: 12px; }
    .empty { text-align: center; padding: 40px; color: var(--text2); }
    .toast { position: fixed; bottom: 100px; left: 50%; transform: translateX(-50%) translateY(100px); background: var(--bg3); border: 1px solid var(--border); padding: 12px 20px; border-radius: 10px; opacity: 0; transition: 0.3s; z-index: 300; }
    .toast.show { transform: translateX(-50%) translateY(0); opacity: 1; }
    .toast.error { border-color: var(--danger); color: var(--danger); }
    .toast.success { border-color: var(--success); color: var(--success); }
    .logout { width: 100%; padding: 14px; background: rgba(255,107,107,0.1); border: 1px solid var(--danger); border-radius: 12px; color: var(--danger); margin-top: 32px; cursor: pointer; }
    .theme-options { display: flex; gap: 8px; margin-top: 12px; }
    .theme-opt { flex: 1; padding: 12px; border-radius: 10px; border: 2px solid var(--border); text-align: center; cursor: pointer; font-size: 20px; }
    .theme-opt.active { border-color: var(--accent); }
  </style>
</head>
<body>
  <div class="app">
    <div class="auth-page" id="authPage">
      <div class="logo">
        <h1>å¥èº«è¿½è¸ªå™¨</h1>
        <p>è®°å½•ä½ çš„æ¯ä¸€æ¬¡è¿›æ­¥</p>
      </div>
      <form class="form" id="loginForm">
        <input type="email" id="loginEmail" placeholder="é‚®ç®±åœ°å€" required>
        <input type="password" id="loginPassword" placeholder="å¯†ç " required>
        <button type="submit" class="btn">ç™»å½•</button>
      </form>
      <p class="switch">è¿˜æ²¡æœ‰è´¦å·ï¼Ÿ<a href="#" id="showRegister">ç«‹å³æ³¨å†Œ</a></p>
    </div>
    <div class="auth-page" id="registerPage" style="display:none">
      <div class="logo">
        <h1>åˆ›å»ºè´¦å·</h1>
        <p>å¼€å§‹ä½ çš„å¥èº«ä¹‹æ—…</p>
      </div>
      <form class="form" id="registerForm">
        <input type="email" id="registerEmail" placeholder="é‚®ç®±åœ°å€" required>
        <input type="password" id="registerPassword" placeholder="è®¾ç½®å¯†ç ï¼ˆè‡³å°‘6ä½ï¼‰" minlength="6" required>
        <button type="submit" class="btn">æ³¨å†Œ</button>
      </form>
      <p class="switch">å·²æœ‰è´¦å·ï¼Ÿ<a href="#" id="showLogin">ç«‹å³ç™»å½•</a></p>
    </div>
    <div class="main-app" id="mainApp" style="display:none">
      <header class="header">
        <h1>å¥èº«è¿½è¸ª</h1>
        <button class="btn" style="padding:8px 16px;font-size:14px" onclick="navigate('settings')">âš™ï¸</button>
      </header>
      <div class="page active" id="homePage">
        <div class="card">
          <div style="display:flex;justify-content:space-between;align-items:center">
            <h3>ğŸ’§ ä»Šæ—¥é¥®æ°´</h3>
            <span id="waterText">0 / 2000 ml</span>
          </div>
          <div class="water-bar"><div class="water-fill" id="waterFill" style="width:0%"></div></div>
          <div class="water-btns">
            <button onclick="addWater(250)">+250ml</button>
            <button onclick="addWater(500)">+500ml</button>
            <button onclick="addWater(1000)">+1000ml</button>
          </div>
        </div>
        <div class="quick-add">
          <button class="quick-btn" onclick="openModal('workout')"><span>ğŸ‹ï¸</span><label>å¥èº«</label></button>
          <button class="quick-btn" onclick="openModal('meal')"><span>ğŸ½ï¸</span><label>é¥®é£Ÿ</label></button>
          <button class="quick-btn" onclick="openModal('weight')"><span>âš–ï¸</span><label>ä½“é‡</label></button>
          <button class="quick-btn" onclick="openModal('water')"><span>ğŸ’§</span><label>å–æ°´</label></button>
        </div>
        <h3 style="margin-bottom:12px">ğŸ“Š æœ¬å‘¨ç»Ÿè®¡</h3>
        <div class="stats-grid">
          <div class="card stat-card"><div class="icon" style="background:rgba(0,212,170,0.2)">ğŸ‹ï¸</div><div class="value" id="weekWorkouts">0</div><div class="label">é”»ç‚¼æ¬¡æ•°</div></div>
          <div class="card stat-card"><div class="icon" style="background:rgba(255,107,107,0.2)">ğŸ”¥</div><div class="value" id="weekCalories">0</div><div class="label">æ‘„å…¥å¡è·¯é‡Œ</div></div>
          <div class="card stat-card"><div class="icon" style="background:rgba(255,217,61,0.2)">ğŸ’ª</div><div class="value" id="weekWeight">--</div><div class="label">å½“å‰ä½“é‡</div></div>
          <div class="card stat-card"><div class="icon" style="background:rgba(107,203,119,0.2)">ğŸ’§</div><div class="value" id="weekWater">0</div><div class="label">é¥®æ°´é‡</div></div>
        </div>
        <h3 style="margin:24px 0 12px">ğŸ“ ä»Šæ—¥è®°å½•</h3>
        <div id="todayRecords"><div class="empty">ä»Šå¤©è¿˜æ²¡æœ‰è®°å½•</div></div>
      </div>
      <div class="page" id="recordsPage">
        <div class="date-selector" id="dateSelector" style="display:flex;gap:12px;margin-bottom:20px;overflow-x:auto"></div>
        <div style="display:flex;gap:8px;margin-bottom:20px">
          <button class="btn" style="padding:8px 16px;font-size:13px" onclick="filterRec('all')">å…¨éƒ¨</button>
          <button class="btn" style="padding:8px 16px;font-size:13px;background:var(--bg3);color:var(--text)" onclick="filterRec('workout')">å¥èº«</button>
          <button class="btn" style="padding:8px 16px;font-size:13px;background:var(--bg3);color:var(--text)" onclick="filterRec('meal')">é¥®é£Ÿ</button>
          <button class="btn" style="padding:8px 16px;font-size:13px;background:var(--bg3);color:var(--text)" onclick="filterRec('weight')">ä½“é‡</button>
        </div>
        <div id="recordsList"><div class="empty">æš‚æ— è®°å½•</div></div>
      </div>
      <div class="page" id="statsPage">
        <h3 style="margin-bottom:16px">ğŸ“ˆ æ•°æ®ç»Ÿè®¡</h3>
        <div class="stats-grid">
          <div class="card stat-card"><div class="icon" style="background:rgba(0,212,170,0.2)">ğŸ‹ï¸</div><div class="value" id="totalWorkouts">0</div><div class="label">æ€»é”»ç‚¼æ¬¡æ•°</div></div>
          <div class="card stat-card"><div class="icon" style="background:rgba(255,107,107,0.2)">ğŸ”¥</div><div class="value" id="totalCalories">0</div><div class="label">æ€»æ‘„å…¥å¡è·¯é‡Œ</div></div>
          <div class="card stat-card"><div class="icon" style="background:rgba(255,217,61,0.2)">ğŸ¥©</div><div class="value" id="totalProtein">0g</div><div class="label">æ€»è›‹ç™½è´¨</div></div>
          <div class="card stat-card"><div class="icon" style="background:rgba(107,203,119,0.2)">ğŸ’§</div><div class="value" id="totalWater">0</div><div class="label">æ€»é¥®æ°´é‡</div></div>
        </div>
        <h3 style="margin:24px 0 12px">ä½“é‡è¶‹åŠ¿</h3>
        <div class="card"><div style="display:flex;justify-content:space-between"><span>æœ€æ–°ä½“é‡</span><span id="latestWeight">--</span></div></div>
        <div class="card"><div style="display:flex;justify-content:space-between"><span>å¹³å‡ä½“é‡</span><span id="avgWeight">--</span></div></div>
        <div class="card"><div style="display:flex;justify-content:space-between"><span>æœ€ä½ä½“é‡</span><span id="minWeight">--</span></div></div>
        <div class="card"><div style="display:flex;justify-content:space-between"><span>æœ€é«˜ä½“é‡</span><span id="maxWeight">--</span></div></div>
      </div>
      <div class="page" id="settingsPage">
        <h3 style="margin-bottom:12px;color:var(--text2);font-size:13px">å¤–è§‚</h3>
        <div class="theme-options">
          <div class="theme-opt active" onclick="setTheme('dark')">ğŸŒ™</div>
          <div class="theme-opt" onclick="setTheme('light')">â˜€ï¸</div>
          <div class="theme-opt" onclick="setTheme('ocean')">ğŸŒŠ</div>
          <div class="theme-opt" onclick="setTheme('sunset')">ğŸŒ…</div>
        </div>
        <h3 style="margin:24px 0 12px;color:var(--text2);font-size:13px">ç›®æ ‡</h3>
        <div class="card" onclick="openGoal('water')" style="cursor:pointer;display:flex;justify-content:space-between"><span>æ¯æ—¥é¥®æ°´ç›®æ ‡</span><span id="waterGoal">2000ml</span></div>
        <div class="card" onclick="openGoal('calorie')" style="cursor:pointer;display:flex;justify-content:space-between"><span>æ¯æ—¥å¡è·¯é‡Œç›®æ ‡</span><span id="calGoal">2000kcal</span></div>
        <button class="logout" onclick="logout()">é€€å‡ºç™»å½•</button>
      </div>
      <nav class="nav">
        <div class="nav-item active" onclick="navigate('home')"><span style="font-size:20px">ğŸ </span><span>é¦–é¡µ</span></div>
        <div class="nav-item" onclick="navigate('records')"><span style="font-size:20px">ğŸ“</span><span>è®°å½•</span></div>
        <div class="nav-item" onclick="navigate('stats')"><span style="font-size:20px">ğŸ“Š</span><span>ç»Ÿè®¡</span></div>
        <div class="nav-item" onclick="navigate('settings')"><span style="font-size:20px">âš™ï¸</span><span>è®¾ç½®</span></div>
      </nav>
    </div>
  </div>
  <div class="modal" id="recordModal">
    <div class="modal-content">
      <div class="modal-header"><h2 id="modalTitle">æ·»åŠ è®°å½•</h2><button class="modal-close" onclick="closeModal()">âœ•</button></div>
      <form id="recordForm">
        <div id="workoutFields" style="display:none">
          <div class="field"><label>è¿åŠ¨ç±»å‹</label><select id="workoutType"><option>åŠ›é‡è®­ç»ƒ</option><option>æœ‰æ°§è¿åŠ¨</option><option>ç‘œä¼½</option><option>æ¸¸æ³³</option><option>éª‘è¡Œ</option><option>è·‘æ­¥</option></select></div>
          <div class="row"><div class="field"><label>æ—¶é•¿(åˆ†é’Ÿ)</label><input type="number" id="workoutDuration"></div><div class="field"><label>é‡é‡(kg)</label><input type="number" id="workoutWeight" step="0.5"></div></div>
          <div class="row"><div class="field"><label>ç»„æ•°</label><input type="number" id="workoutSets"></div><div class="field"><label>æ¬¡æ•°</label><input type="number" id="workoutReps"></div></div>
        </div>
        <div id="mealFields" style="display:none">
          <div class="field"><label>é¤æ¬¡</label><select id="mealType"><option>æ—©é¤</option><option>åˆé¤</option><option>æ™šé¤</option><option>åŠ é¤</option></select></div>
          <div class="field"><label>é£Ÿç‰©</label><input type="text" id="mealFood" required></div>
          <div class="row"><div class="field"><label>å¡è·¯é‡Œ</label><input type="number" id="mealCalories"></div><div class="field"><label>è›‹ç™½è´¨(g)</label><input type="number" id="mealProtein" step="0.1"></div></div>
        </div>
        <div id="weightFields" style="display:none"><div class="field"><label>ä½“é‡(kg)</label><input type="number" id="weightValue" step="0.1" required></div></div>
        <div id="waterFields" style="display:none"><div class="field"><label>é¥®æ°´é‡(ml)</label><input type="number" id="waterAmount" required></div></div>
        <div class="field"><label>æ—¥æœŸ</label><input type="date" id="recordDate"></div>
        <button type="submit" class="btn">ä¿å­˜</button>
      </form>
    </div>
  </div>
  <div class="modal" id="goalModal">
    <div class="modal-content">
      <div class="modal-header"><h2 id="goalTitle">è®¾ç½®ç›®æ ‡</h2><button class="modal-close" onclick="document.getElementById('goalModal').classList.remove('active')">âœ•</button></div>
      <form id="goalForm">
        <div class="field"><label id="goalLabel">ç›®æ ‡å€¼</label><input type="number" id="goalValue" required></div>
        <button type="submit" class="btn">ä¿å­˜</button>
      </form>
    </div>
  </div>
  <div class="toast" id="toast"></div>

  <!-- Firebase SDK -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
    import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js";
    import { getDatabase, ref, set, get, update, onValue } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-database.js";

    // ========== Firebase é…ç½® ==========
    // TODO: è¯·æ›¿æ¢ä¸ºä½ çš„ Firebase é…ç½®
    // 1. å» https://console.firebase.google.com/ åˆ›å»ºä¸€ä¸ªé¡¹ç›®
    // 2. å¼€å¯ "Authentication" - é‚®ç®±/å¯†ç ç™»å½•
    // 3. å¼€å¯ "Realtime Database" - åˆ›å»ºæ•°æ®åº“ï¼ˆé€‰æµ‹è¯•æ¨¡å¼æˆ–é”å®šæ¨¡å¼ï¼‰
    // 4. æŠŠé¡¹ç›®è®¾ç½®é‡Œçš„é…ç½®å¤åˆ¶ä¸‹æ¥
    const firebaseConfig = {
      apiKey: "YOUR_API_KEY",
      authDomain: "YOUR_PROJECT.firebaseapp.com",
      databaseURL: "https://YOUR_PROJECT-default-rtdb.firebaseio.com",
      projectId: "YOUR_PROJECT",
      storageBucket: "YOUR_PROJECT.appspot.com",
      messagingSenderId: "YOUR_SENDER_ID",
      appId: "YOUR_APP_ID"
    };

    // åˆå§‹åŒ– Firebase
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getDatabase(app);

    // å…¨å±€å˜é‡
    let currentUser = null;
    let userData = null;
    let settings = { theme: 'dark', daily_water_goal: 2000, daily_calorie_goal: 2000 };
    let currentPage = 'home';
    let currentModal = '';
    let currentGoalType = '';
    let selectedDate = new Date().toISOString().split('T')[0];
    let allRecords = { workouts: [], meals: [], weights: [], water: [] };

    // ç›‘å¬ç™»å½•çŠ¶æ€
    onAuthStateChanged(auth, async (user) => {
      if (user) {
        currentUser = user;
        await loadUserData();
        showMainApp();
      } else {
        showAuthPage();
      }
    });

    // åŠ è½½ç”¨æˆ·æ•°æ®
    async function loadUserData() {
      try {
        const snapshot = await get(ref(db, 'users/' + currentUser.uid));
        if (snapshot.exists()) {
          userData = snapshot.val();
          settings = userData.settings || { theme: 'dark', daily_water_goal: 2000, daily_calorie_goal: 2000 };
          applyTheme(settings.theme);
          loadTodayData();
          loadWeekStats();
          loadAllStats();
        } else {
          // æ–°ç”¨æˆ·ï¼Œåˆ›å»ºåˆå§‹æ•°æ®
          userData = {
            workouts: {}, meals: {}, weights: {}, water: {},
            settings: settings
          };
          await set(ref(db, 'users/' + currentUser.uid), userData);
        }
      } catch(e) {
        console.error('åŠ è½½æ•°æ®å¤±è´¥', e);
        showToast('åŠ è½½æ•°æ®å¤±è´¥: ' + e.message, 'error');
      }
    }

    // ä¿å­˜æ•°æ®
    async function saveData() {
      if (!currentUser || !userData) return;
      try {
        await update(ref(db, 'users/' + currentUser.uid), userData);
      } catch(e) {
        console.error('ä¿å­˜å¤±è´¥', e);
      }
    }

    // æ³¨å†Œ
    window.handleRegister = async (e) => {
      e.preventDefault();
      const email = document.getElementById('registerEmail').value;
      const password = document.getElementById('registerPassword').value;
      try {
        await createUserWithEmailAndPassword(auth, email, password);
        showToast('æ³¨å†ŒæˆåŠŸï¼', 'success');
      } catch(e) {
        showToast(e.message, 'error');
      }
    };

    // ç™»å½•
    window.handleLogin = async (e) => {
      e.preventDefault();
      const email = document.getElementById('loginEmail').value;
      const password = document.getElementById('loginPassword').value;
      try {
        await signInWithEmailAndPassword(auth, email, password);
      } catch(e) {
        showToast(e.message, 'error');
      }
    };

    // é€€å‡º
    window.logout = async () => {
      await signOut(auth);
      userData = null;
      location.reload();
    };

    // é¡µé¢å¯¼èˆª
    window.navigate = (page) => {
      currentPage = page;
      document.querySelectorAll('.nav-item').forEach((el, i) => {
        el.classList.toggle('active', ['home','records','stats','settings'][i] === page);
      });
      document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
      document.getElementById(page + 'Page').classList.add('active');
      if (page === 'records') renderDateSelector();
    };

    // åŠ è½½ä»Šæ—¥æ•°æ®
    function loadTodayData() {
      const date = new Date().toISOString().split('T')[0];
      allRecords.workouts = Object.values(userData.workouts || {}).filter(r => r.date === date);
      allRecords.meals = Object.values(userData.meals || {}).filter(r => r.date === date);
      allRecords.weights = Object.values(userData.weights || {}).filter(r => r.date === date);
      allRecords.water = Object.values(userData.water || {}).filter(r => r.date === date);
      renderTodayRecords();
      renderWaterProgress();
    }

    function loadWeekStats() {
      const today = new Date();
      const weekAgo = new Date(today.getTime() - 7*24*60*60*1000).toISOString().split('T')[0];
      const todayStr = today.toISOString().split('T')[0];
      const workouts = Object.values(userData.workouts || {}).filter(r => r.date >= weekAgo && r.date <= todayStr);
      const meals = Object.values(userData.meals || {}).filter(r => r.date >= weekAgo && r.date <= todayStr);
      const water = Object.values(userData.water || {}).filter(r => r.date >= weekAgo && r.date <= todayStr);
      const weights = Object.values(userData.weights || {}).filter(r => r.date >= weekAgo && r.date <= todayStr);
      
      document.getElementById('weekWorkouts').textContent = workouts.length;
      document.getElementById('weekCalories').textContent = meals.reduce((s,m) => s + (m.calories||0), 0);
      document.getElementById('weekWater').textContent = water.reduce((s,w) => s + w.amount, 0);
      if (weights.length) {
        document.getElementById('weekWeight').textContent = (weights.reduce((s,w) => s + w.weight, 0) / weights.length).toFixed(1) + 'kg';
      }
    }

    function loadAllStats() {
      const workouts = Object.values(userData.workouts || {});
      const meals = Object.values(userData.meals || {});
      const water = Object.values(userData.water || {});
      const weights = Object.values(userData.weights || {});
      
      document.getElementById('totalWorkouts').textContent = workouts.length;
      document.getElementById('totalCalories').textContent = meals.reduce((s,m) => s + (m.calories||0), 0);
      document.getElementById('totalProtein').textContent = meals.reduce((s,m) => s + (m.protein||0), 0).toFixed(1) + 'g';
      document.getElementById('totalWater').textContent = water.reduce((s,w) => s + w.amount, 0);
      
      if (weights.length) {
        document.getElementById('latestWeight').textContent = weights[weights.length-1].weight + 'kg';
        document.getElementById('avgWeight').textContent = (weights.reduce((s,w) => s + w.weight, 0) / weights.length).toFixed(1) + 'kg';
        document.getElementById('minWeight').textContent = Math.min(...weights.map(w => w.weight)) + 'kg';
        document.getElementById('maxWeight').textContent = Math.max(...weights.map(w => w.weight)) + 'kg';
      }
    }

    function renderTodayRecords() {
      const records = [];
      allRecords.workouts.forEach(r => records.push({...r, type:'workout', title:r.type, meta:`${r.duration||0}åˆ†é’Ÿ`}));
      allRecords.meals.forEach(r => records.push({...r, type:'meal', title:r.food, meta:`${r.calories||0}kcal`}));
      allRecords.weights.forEach(r => records.push({...r, type:'weight', title:'ä½“é‡', meta:`${r.weight}kg`}));
      allRecords.water.forEach(r => records.push({...r, type:'water', title:'å–æ°´', meta:`${r.amount}ml`}));
      
      if (!records.length) {
        document.getElementById('todayRecords').innerHTML = '<div class="empty">ä»Šå¤©è¿˜æ²¡æœ‰è®°å½•</div>';
        return;
      }
      document.getElementById('todayRecords').innerHTML = records.map(r => 
        `<div class="card" style="display:flex;justify-content:space-between;align-items:center">
          <div><div style="font-weight:600">${r.title}</div><div style="font-size:13px;color:var(--text2)">${r.meta}</div></div>
          <button onclick="deleteRecord('${r.type}','${r.id}')" style="background:none;border:none;font-size:20px;cursor:pointer">ğŸ—‘ï¸</button>
        </div>`
      ).join('');
    }

    function renderWaterProgress() {
      const todayWater = allRecords.water.reduce((s,r) => s + r.amount, 0);
      const goal = settings.daily_water_goal || 2000;
      document.getElementById('waterText').textContent = `${todayWater} / ${goal} ml`;
      document.getElementById('waterFill').style.width = Math.min((todayWater/goal)*100, 100) + '%';
    }

    function renderDateSelector() {
      const container = document.getElementById('dateSelector');
      container.innerHTML = [6,5,4,3,2,1,0].map(i => {
        const d = new Date(); d.setDate(d.getDate() - i);
        const ds = d.toISOString().split('T')[0];
        const active = ds === selectedDate ? 'background:var(--accent);color:var(--bg)' : '';
        return `<button onclick="selectDate('${ds}')" style="padding:8px 12px;border-radius:20px;border:1px solid var(--border);background:${active};color:var(--text);cursor:pointer;font-size:13px">${d.getMonth()+1}/${d.getDate()}</button>`;
      }).join('');
      loadRecordsForDate(selectedDate);
    }

    function loadRecordsForDate(date) {
      selectedDate = date;
      allRecords.workouts = Object.values(userData.workouts || {}).filter(r => r.date === date);
      allRecords.meals = Object.values(userData.meals || {}).filter(r => r.date === date);
      allRecords.weights = Object.values(userData.weights || {}).filter(r => r.date === date);
      allRecords.water = Object.values(userData.water || {}).filter(r => r.date === date);
      renderRecordsList();
    }

    function renderRecordsList() {
      const records = [];
      allRecords.workouts.forEach(r => records.push({...r, type:'workout', title:r.type, meta:`${r.duration||0}åˆ†é’Ÿ`}));
      allRecords.meals.forEach(r => records.push({...r, type:'meal', title:r.food, meta:`${r.calories||0}kcal`}));
      allRecords.weights.forEach(r => records.push({...r, type:'weight', title:'ä½“é‡', meta:`${r.weight}kg`}));
      
      if (!records.length) {
        document.getElementById('recordsList').innerHTML = '<div class="empty">æš‚æ— è®°å½•</div>';
        return;
      }
      document.getElementById('recordsList').innerHTML = records.map(r => 
        `<div class="card" style="display:flex;justify-content:space-between;align-items:center">
          <div><div style="font-weight:600">${r.title}</div><div style="font-size:13px;color:var(--text2)">${r.meta}</div></div>
          <button onclick="deleteRecord('${r.type}','${r.id}')" style="background:none;border:none;font-size:20px;cursor:pointer">ğŸ—‘ï¸</button>
        </div>`
      ).join('');
    }

    window.filterRec = (type) => {
      const records = [];
      if (type === 'all' || type === 'workout') allRecords.workouts.forEach(r => records.push({...r, type:'workout', title:r.type, meta:`${r.duration||0}åˆ†é’Ÿ`}));
      if (type === 'all' || type === 'meal') allRecords.meals.forEach(r => records.push({...r, type:'meal', title:r.food, meta:`${r.calories||0}kcal`}));
      if (type === 'all' || type === 'weight') allRecords.weights.forEach(r => records.push({...r, type:'weight', title:'ä½“é‡', meta:`${r.weight}kg`}));
      
      if (!records.length) {
        document.getElementById('recordsList').innerHTML = '<div class="empty">æš‚æ— è®°å½•</div>';
        return;
      }
      document.getElementById('recordsList').innerHTML = records.map(r => 
        `<div class="card" style="display:flex;justify-content:space-between;align-items:center">
          <div><div style="font-weight:600">${r.title}</div><div style="font-size:13px;color:var(--text2)">${r.meta}</div></div>
          <button onclick="deleteRecord('${r.type}','${r.id}')" style="background:none;border:none;font-size:20px;cursor:pointer">ğŸ—‘ï¸</button>
        </div>`
      ).join('');
    };

    window.selectDate = (date) => { loadRecordsForDate(date); };

    window.openModal = (type) => {
      currentModal = type;
      const titles = {workout:'æ·»åŠ å¥èº«',meal:'æ·»åŠ é¥®é£Ÿ',weight:'è®°å½•ä½“é‡',water:'è®°å½•å–æ°´'};
      document.getElementById('modalTitle').textContent = titles[type];
      document.getElementById('workoutFields').style.display = type==='workout'?'block':'none';
      document.getElementById('mealFields').style.display = type==='meal'?'block':'none';
      document.getElementById('weightFields').style.display = type==='weight'?'block':'none';
      document.getElementById('waterFields').style.display = type==='water'?'block':'none';
      document.getElementById('recordDate').value = selectedDate;
      document.getElementById('recordModal').classList.add('active');
    };

    window.closeModal = () => {
      document.getElementById('recordModal').classList.remove('active');
      document.getElementById('recordForm').reset();
    };

    window.handleRecordSubmit = async (e) => {
      e.preventDefault();
      const date = document.getElementById('recordDate').value;
      const id = Date.now().toString();
      let record = { id, date };
      
      if (currentModal === 'workout') {
        record = {...record, type:document.getElementById('workoutType').value, duration:parseInt(document.getElementById('workoutDuration').value)||0, weight:parseFloat(document.getElementById('workoutWeight').value)||0};
        userData.workouts = userData.workouts || {};
        userData.workouts[id] = record;
      } else if (currentModal === 'meal') {
        record = {...record, type:document.getElementById('mealType').value, food:document.getElementById('mealFood').value, calories:parseInt(document.getElementById('mealCalories').value)||0, protein:parseFloat(document.getElementById('mealProtein').value)||0};
        userData.meals = userData.meals || {};
        userData.meals[id] = record;
      } else if (currentModal === 'weight') {
        record = {...record, weight:parseFloat(document.getElementById('weightValue').value)};
        userData.weights = userData.weights || {};
        userData.weights[id] = record;
      } else if (currentModal === 'water') {
        record = {...record, amount:parseInt(document.getElementById('waterAmount').value)};
        userData.water = userData.water || {};
        userData.water[id] = record;
      }
      
      await saveData();
      showToast('è®°å½•å·²ä¿å­˜', 'success');
      closeModal();
      loadTodayData();
      loadWeekStats();
      loadAllStats();
    };

    window.addWater = async (amount) => {
      const date = new Date().toISOString().split('T')[0];
      const id = Date.now().toString();
      userData.water = userData.water || {};
      userData.water[id] = { id, date, amount };
      await saveData();
      showToast(`å·²æ·»åŠ  ${amount}ml`, 'success');
      loadTodayData();
      loadWeekStats();
    };

    window.deleteRecord = async (type, id) => {
      if (!confirm('ç¡®å®šåˆ é™¤ï¼Ÿ')) return;
      if (type === 'workout' && userData.workouts) delete userData.workouts[id];
      else if (type === 'meal' && userData.meals) delete userData.meals[id];
      else if (type === 'weight' && userData.weights) delete userData.weights[id];
      else if (type === 'water' && userData.water) delete userData.water[id];
      await saveData();
      showToast('å·²åˆ é™¤', 'success');
      loadTodayData();
      loadWeekStats();
      loadAllStats();
      if (currentPage === 'records') loadRecordsForDate(selectedDate);
    };

    window.openGoal = (type) => {
      currentGoalType = type;
      document.getElementById('goalTitle').textContent = type === 'water' ? 'æ¯æ—¥é¥®æ°´ç›®æ ‡' : 'æ¯æ—¥å¡è·¯é‡Œç›®æ ‡';
      document.getElementById('goalLabel').textContent = type === 'water' ? 'ç›®æ ‡é¥®æ°´é‡(ml)' : 'ç›®æ ‡å¡è·¯é‡Œ(kcal)';
      document.getElementById('goalValue').value = type === 'water' ? settings.daily_water_goal : settings.daily_calorie_goal;
      document.getElementById('goalModal').classList.add('active');
    };

    window.handleGoalSubmit = async (e) => {
      e.preventDefault();
      const value = parseInt(document.getElementById('goalValue').value);
      if (currentGoalType === 'water') {
        settings.daily_water_goal = value;
        document.getElementById('waterGoal').textContent = value + 'ml';
      } else {
        settings.daily_calorie_goal = value;
        document.getElementById('calGoal').textContent = value + 'kcal';
      }
      userData.settings = settings;
      await saveData();
      showToast('ç›®æ ‡å·²æ›´æ–°', 'success');
      document.getElementById('goalModal').classList.remove('active');
      loadTodayData();
    };

    window.setTheme = async (theme) => {
      settings.theme = theme;
      userData.settings = settings;
      await saveData();
      applyTheme(theme);
      document.querySelectorAll('.theme-opt').forEach(o => o.classList.toggle('active', o.textContent.includes({'dark':'ğŸŒ™','light':'â˜€ï¸','ocean':'ğŸŒŠ','sunset':'ğŸŒ…'}[theme])));
    };

    function applyTheme(theme) {
      document.body.className = 'theme-' + theme;
      const icons = {'dark':'ğŸŒ™','light':'â˜€ï¸','ocean':'ğŸŒŠ','sunset':'ğŸŒ…'};
      document.querySelectorAll('.theme-opt').forEach(o => o.classList.toggle('active', o.textContent === icons[theme]));
    }

    function showAuthPage() {
      document.getElementById('authPage').style.display = 'flex';
      document.getElementById('registerPage').style.display = 'none';
      document.getElementById('mainApp').style.display = 'none';
    }

    function showMainApp() {
      document.getElementById('authPage').style.display = 'none';
      document.getElementById('registerPage').style.display = 'none';
      document.getElementById('mainApp').style.display = 'block';
      document.getElementById('waterGoal').textContent = settings.daily_water_goal + 'ml';
      document.getElementById('calGoal').textContent = settings.daily_calorie_goal + 'kcal';
    }

    function showToast(msg, type='') {
      const t = document.getElementById('toast');
      t.textContent = msg;
      t.className = 'toast ' + type + ' show';
      setTimeout(() => t.classList.remove('show'), 2500);
    }

    // äº‹ä»¶ç›‘å¬
    document.getElementById('registerForm').addEventListener('submit', handleRegister);
    document.getElementById('loginForm').addEventListener('submit', handleLogin);
    document.getElementById('recordForm').addEventListener('submit', handleRecordSubmit);
    document.getElementById('goalForm').addEventListener('submit', handleGoalSubmit);
    document.getElementById('showRegister').addEventListener('click', e => { e.preventDefault(); document.getElementById('authPage').style.display = 'none'; document.getElementById('registerPage').style.display = 'flex'; });
    document.getElementById('showLogin').addEventListener('click', e => { e.preventDefault(); document.getElementById('registerPage').style.display = 'none'; document.getElementById('authPage').style.display = 'flex'; });
    document.getElementById('recordModal').addEventListener('click', e => { if (e.target.id === 'recordModal') closeModal(); });
  </script>
</body>
</html>
