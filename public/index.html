<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>å¥èº«è¿½è¸ªå™¨</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <style>
    :root { --bg-primary: #0f0f0f; --bg-secondary: #1a1a1a; --bg-tertiary: #252525; --text-primary: #ffffff; --text-secondary: #a0a0a0; --text-muted: #666666; --accent: #00d4aa; --accent-glow: rgba(0, 212, 170, 0.3); --danger: #ff6b6b; --success: #6bcb77; --card-bg: rgba(255, 255, 255, 0.03); --border: rgba(255, 255, 255, 0.08); }
    .theme-light { --bg-primary: #f5f5f7; --bg-secondary: #ffffff; --bg-tertiary: #e8e8ed; --text-primary: #1d1d1f; --text-secondary: #6e6e73; --accent: #00a884; --card-bg: rgba(255,255,255,0.8); --border: rgba(0,0,0,0.08); }
    .theme-ocean { --bg-primary: #0a1628; --bg-secondary: #112240; --bg-tertiary: #1a3152; --accent: #64ffda; --accent-glow: rgba(100,255,218,0.25); --card-bg: rgba(100,255,218,0.05); --border: rgba(100,255,218,0.15); }
    .theme-sunset { --bg-primary: #1a0a0a; --bg-secondary: #2d1515; --bg-tertiary: #3d1f1f; --accent: #ff6b6b; --accent-glow: rgba(255,107,107,0.25); --card-bg: rgba(255,107,107,0.05); --border: rgba(255,107,107,0.15); }
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { font-family: 'Inter', -apple-system, sans-serif; background: var(--bg-primary); color: var(--text-primary); min-height: 100vh; transition: 0.3s; -webkit-tap-highlight-color: transparent; }
    .app { max-width: 480px; margin: 0 auto; min-height: 100vh; }
    .auth-page { min-height: 100vh; display: flex; flex-direction: column; justify-content: center; padding: 24px; background: linear-gradient(135deg, var(--bg-primary), var(--bg-secondary)); }
    .auth-logo { text-align: center; margin-bottom: 40px; }
    .auth-logo svg { width: 80px; height: 80px; }
    .auth-logo h1 { font-size: 28px; font-weight: 700; background: linear-gradient(135deg, var(--accent), #00ffcc); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
    .auth-logo p { color: var(--text-secondary); margin-top: 8px; }
    .auth-form { display: flex; flex-direction: column; gap: 16px; }
    .input-group input { width: 100%; padding: 16px 20px; background: var(--bg-tertiary); border: 1px solid var(--border); border-radius: 12px; color: var(--text-primary); font-size: 16px; outline: none; }
    .input-group input:focus { border-color: var(--accent); box-shadow: 0 0 0 3px var(--accent-glow); }
    .btn { padding: 16px 24px; border: none; border-radius: 12px; font-size: 16px; font-weight: 600; cursor: pointer; transition: 0.2s; }
    .btn-primary { background: var(--accent); color: var(--bg-primary); }
    .btn-block { width: 100%; }
    .auth-switch { text-align: center; margin-top: 24px; color: var(--text-secondary); }
    .auth-switch a { color: var(--accent); text-decoration: none; font-weight: 500; }
    .main-app { display: none; }
    .header { position: sticky; top: 0; background: var(--bg-primary); padding: 16px 20px; display: flex; justify-content: space-between; align-items: center; z-index: 100; backdrop-filter: blur(12px); }
    .header h1 { font-size: 20px; font-weight: 600; }
    .icon-btn { width: 40px; height: 40px; border-radius: 10px; background: var(--bg-tertiary); border: none; color: var(--text-primary); cursor: pointer; display: flex; align-items: center; justify-content: center; }
    .bottom-nav { position: fixed; bottom: 0; left: 0; right: 0; background: var(--bg-secondary); border-top: 1px solid var(--border); display: flex; justify-content: space-around; padding: 8px 0; padding-bottom: calc(8px + env(safe-area-inset-bottom)); z-index: 100; }
    .nav-item { flex: 1; display: flex; flex-direction: column; align-items: center; gap: 4px; padding: 8px; color: var(--text-muted); text-decoration: none; font-size: 11px; font-weight: 500; }
    .nav-item.active { color: var(--accent); }
    .nav-item svg { width: 24px; height: 24px; }
    .page { display: none; padding: 20px; padding-bottom: 100px; }
    .page.active { display: block; }
    .stats-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 12px; margin-bottom: 24px; }
    .stat-card { background: var(--card-bg); border: 1px solid var(--border); border-radius: 16px; padding: 20px; }
    .stat-card .icon { width: 40px; height: 40px; border-radius: 10px; display: flex; align-items: center; justify-content: center; margin-bottom: 12px; font-size: 20px; }
    .stat-card .value { font-size: 28px; font-weight: 700; margin-bottom: 4px; }
    .stat-card .label { font-size: 13px; color: var(--text-secondary); }
    .record-card { background: var(--card-bg); border: 1px solid var(--border); border-radius: 16px; padding: 16px; margin-bottom: 12px; display: flex; justify-content: space-between; align-items: center; }
    .record-card .info { flex: 1; }
    .record-card .title { font-weight: 600; margin-bottom: 4px; }
    .record-card .meta { font-size: 13px; color: var(--text-secondary); }
    .record-card .btn-icon { width: 32px; height: 32px; border-radius: 8px; background: var(--bg-tertiary); border: none; color: var(--text-secondary); cursor: pointer; }
    .quick-add { display: grid; grid-template-columns: repeat(4, 1fr); gap: 8px; margin-bottom: 24px; }
    .quick-add-btn { aspect-ratio: 1; border-radius: 16px; background: var(--card-bg); border: 1px solid var(--border); display: flex; flex-direction: column; align-items: center; justify-content: center; gap: 6px; cursor: pointer; }
    .quick-add-btn:hover { border-color: var(--accent); transform: scale(1.05); }
    .quick-add-btn span { font-size: 24px; }
    .quick-add-btn label { font-size: 10px; color: var(--text-secondary); }
    .modal-overlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.6); backdrop-filter: blur(4px); display: none; align-items: flex-end; justify-content: center; z-index: 200; }
    .modal-overlay.active { display: flex; }
    .modal { width: 100%; max-width: 480px; background: var(--bg-secondary); border-radius: 24px 24px 0 0; padding: 24px; animation: slideUp 0.3s; }
    @keyframes slideUp { from { transform: translateY(100%); } to { transform: translateY(0); } }
    .modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
    .modal-header h2 { font-size: 20px; }
    .modal-close { width: 32px; height: 32px; border-radius: 8px; background: var(--bg-tertiary); border: none; color: var(--text-primary); cursor: pointer; }
    .form-group { margin-bottom: 16px; }
    .form-group label { display: block; font-size: 13px; color: var(--text-secondary); margin-bottom: 8px; }
    .form-group input, .form-group select { width: 100%; padding: 14px 16px; background: var(--bg-tertiary); border: 1px solid var(--border); border-radius: 12px; color: var(--text-primary); font-size: 16px; outline: none; }
    .form-group input:focus { border-color: var(--accent); }
    .form-row { display: grid; grid-template-columns: repeat(2, 1fr); gap: 12px; }
    .water-progress { background: var(--card-bg); border: 1px solid var(--border); border-radius: 20px; padding: 20px; margin-bottom: 24px; }
    .water-header { display: flex; justify-content: space-between; margin-bottom: 16px; }
    .water-header h3 { font-size: 16px; }
    .water-progress-bar { height: 12px; background: var(--bg-tertiary); border-radius: 6px; overflow: hidden; margin-bottom: 8px; }
    .water-progress-fill { height: 100%; background: linear-gradient(90deg, #00d4aa, #00ffcc); border-radius: 6px; transition: width 0.3s; }
    .water-controls { display: flex; gap: 8px; margin-top: 16px; }
    .water-btn { flex: 1; padding: 12px; border-radius: 10px; background: var(--bg-tertiary); border: 1px solid var(--border); color: var(--text-primary); font-size: 14px; cursor: pointer; }
    .water-btn:hover { border-color: var(--accent); background: var(--accent); color: var(--bg-primary); }
    .date-selector { display: flex; gap: 12px; margin-bottom: 20px; overflow-x: auto; }
    .date-btn { flex-shrink: 0; padding: 8px 16px; border-radius: 20px; background: var(--bg-tertiary); border: 1px solid var(--border); color: var(--text-secondary); font-size: 13px; cursor: pointer; }
    .date-btn.active { background: var(--accent); color: var(--bg-primary); border-color: var(--accent); }
    .settings-section { margin-bottom: 24px; }
    .settings-section h3 { font-size: 13px; color: var(--text-secondary); text-transform: uppercase; margin-bottom: 12px; }
    .settings-item { background: var(--card-bg); border: 1px solid var(--border); border-radius: 12px; padding: 16px; display: flex; justify-content: space-between; margin-bottom: 8px; cursor: pointer; }
    .theme-options { display: flex; gap: 8px; margin-top: 12px; }
    .theme-option { flex: 1; padding: 12px; border-radius: 10px; border: 2px solid var(--border); cursor: pointer; text-align: center; font-size: 13px; }
    .theme-option.active { border-color: var(--accent); }
    .empty-state { text-align: center; padding: 40px; color: var(--text-muted); }
    .toast { position: fixed; bottom: 100px; left: 50%; transform: translateX(-50%) translateY(100px); background: var(--bg-tertiary); border: 1px solid var(--border); padding: 12px 20px; border-radius: 10px; font-size: 14px; opacity: 0; transition: 0.3s; z-index: 300; }
    .toast.show { transform: translateX(-50%) translateY(0); opacity: 1; }
    .toast.success { border-color: var(--success); color: var(--success); }
    .toast.error { border-color: var(--danger); color: var(--danger); }
    .logout-btn { width: 100%; padding: 14px; background: rgba(255,107,107,0.1); border: 1px solid var(--danger); border-radius: 12px; color: var(--danger); font-size: 15px; cursor: pointer; margin-top: 32px; }
  </style>
</head>
<body>
  <div class="app">
    <div class="auth-page" id="authPage">
      <div class="auth-logo">
        <svg viewBox="0 0 80 80" fill="none"><circle cx="40" cy="40" r="36" stroke="url(#grad)" stroke-width="4"/><path d="M40 20 L40 45 M28 33 L40 45 L52 33" stroke="url(#grad)" stroke-width="3" stroke-linecap="round"/><defs><linearGradient id="grad" x1="0" y1="0" x2="100" y2="100"><stop offset="0" stop-color="#00d4aa"/><stop offset="100" stop-color="#00ffcc"/></linearGradient></defs></svg>
        <h1>å¥èº«è¿½è¸ªå™¨</h1>
        <p>è®°å½•ä½ çš„æ¯ä¸€æ¬¡è¿›æ­¥</p>
      </div>
      <form class="auth-form" id="loginForm">
        <div class="input-group"><input type="email" id="loginEmail" placeholder="é‚®ç®±åœ°å€" required></div>
        <div class="input-group"><input type="password" id="loginPassword" placeholder="å¯†ç " required></div>
        <button type="submit" class="btn btn-primary btn-block">ç™»å½•</button>
      </form>
      <p class="auth-switch">è¿˜æ²¡æœ‰è´¦å·ï¼Ÿ<a href="#" id="showRegister">ç«‹å³æ³¨å†Œ</a></p>
    </div>
    <div class="auth-page" id="registerPage" style="display:none">
      <div class="auth-logo">
        <svg viewBox="0 0 80 80" fill="none"><circle cx="40" cy="40" r="36" stroke="url(#grad)" stroke-width="4"/><path d="M40 20 L40 45 M28 33 L40 45 L52 33" stroke="url(#grad)" stroke-width="3" stroke-linecap="round"/><defs><linearGradient id="grad" x1="0" y1="0" x2="100" y2="100"><stop offset="0" stop-color="#00d4aa"/><stop offset="100" stop-color="#00ffcc"/></linearGradient></defs></svg>
        <h1>åˆ›å»ºè´¦å·</h1>
        <p>å¼€å§‹ä½ çš„å¥èº«ä¹‹æ—…</p>
      </div>
      <form class="auth-form" id="registerForm">
        <div class="input-group"><input type="email" id="registerEmail" placeholder="é‚®ç®±åœ°å€" required></div>
        <div class="input-group"><input type="password" id="registerPassword" placeholder="è®¾ç½®å¯†ç ï¼ˆè‡³å°‘6ä½ï¼‰" minlength="6" required></div>
        <button type="submit" class="btn btn-primary btn-block">æ³¨å†Œ</button>
      </form>
      <p class="auth-switch">å·²æœ‰è´¦å·ï¼Ÿ<a href="#" id="showLogin">ç«‹å³ç™»å½•</a></p>
    </div>
    <div class="main-app" id="mainApp">
      <header class="header"><h1>å¥èº«è¿½è¸ª</h1><button class="icon-btn" id="settingsBtn">âš™ï¸</button></header>
      <div class="page active" id="homePage">
        <div class="water-progress">
          <div class="water-header"><h3>ğŸ’§ ä»Šæ—¥é¥®æ°´</h3><span id="waterText">0 / 2000 ml</span></div>
          <div class="water-progress-bar"><div class="water-progress-fill" id="waterFill" style="width:0%"></div></div>
          <div class="water-controls">
            <button class="water-btn" onclick="addWater(250)">+250ml</button>
            <button class="water-btn" onclick="addWater(500)">+500ml</button>
            <button class="water-btn" onclick="addWater(1000)">+1000ml</button>
          </div>
        </div>
        <div class="quick-add">
          <button class="quick-add-btn" onclick="openModal('workout')"><span>ğŸ‹ï¸</span><label>å¥èº«</label></button>
          <button class="quick-add-btn" onclick="openModal('meal')"><span>ğŸ½ï¸</span><label>é¥®é£Ÿ</label></button>
          <button class="quick-add-btn" onclick="openModal('weight')"><span>âš–ï¸</span><label>ä½“é‡</label></button>
          <button class="quick-add-btn" onclick="openModal('water')"><span>ğŸ’§</span><label>å–æ°´</label></button>
        </div>
        <h3 style="margin-bottom:12px">ğŸ“Š æœ¬å‘¨ç»Ÿè®¡</h3>
        <div class="stats-grid">
          <div class="stat-card"><div class="icon" style="background:rgba(0,212,170,0.2)">ğŸ‹ï¸</div><div class="value" id="weekWorkouts">0</div><div class="label">é”»ç‚¼æ¬¡æ•°</div></div>
          <div class="stat-card"><div class="icon" style="background:rgba(255,107,107,0.2)">ğŸ”¥</div><div class="value" id="weekCalories">0</div><div class="label">æ‘„å…¥å¡è·¯é‡Œ</div></div>
          <div class="stat-card"><div class="icon" style="background:rgba(255,217,61,0.2)">ğŸ’ª</div><div class="value" id="weekWeight">--</div><div class="label">å½“å‰ä½“é‡</div></div>
          <div class="stat-card"><div class="icon" style="background:rgba(107,203,119,0.2)">ğŸ’§</div><div class="value" id="weekWater">0</div><div class="label">é¥®æ°´é‡</div></div>
        </div>
        <h3 style="margin:24px 0 12px">ğŸ“ ä»Šæ—¥è®°å½•</h3>
        <div id="todayRecords"><div class="empty-state"><p>ä»Šå¤©è¿˜æ²¡æœ‰è®°å½•</p></div></div>
      </div>
      <div class="page" id="recordsPage">
        <div class="date-selector" id="dateSelector"></div>
        <div style="display:flex;gap:8px;margin-bottom:20px">
          <button class="date-btn active" onclick="filterRecords('all')">å…¨éƒ¨</button>
          <button class="date-btn" onclick="filterRecords('workout')">å¥èº«</button>
          <button class="date-btn" onclick="filterRecords('meal')">é¥®é£Ÿ</button>
          <button class="date-btn" onclick="filterRecords('weight')">ä½“é‡</button>
        </div>
        <div id="recordsList"><div class="empty-state"><p>æš‚æ— è®°å½•</p></div></div>
      </div>
      <div class="page" id="statsPage">
        <h3 style="margin-bottom:16px">ğŸ“ˆ æ•°æ®ç»Ÿè®¡</h3>
        <div class="stats-grid">
          <div class="stat-card"><div class="icon" style="background:rgba(0,212,170,0.2)">ğŸ‹ï¸</div><div class="value" id="totalWorkouts">0</div><div class="label">æ€»é”»ç‚¼æ¬¡æ•°</div></div>
          <div class="stat-card"><div class="icon" style="background:rgba(255,107,107,0.2)">ğŸ”¥</div><div class="value" id="totalCalories">0</div><div class="label">æ€»æ‘„å…¥å¡è·¯é‡Œ</div></div>
          <div class="stat-card"><div class="icon" style="background:rgba(255,217,61,0.2)">ğŸ¥©</div><div class="value" id="totalProtein">0g</div><div class="label">æ€»è›‹ç™½è´¨</div></div>
          <div class="stat-card"><div class="icon" style="background:rgba(107,203,119,0.2)">ğŸ’§</div><div class="value" id="totalWater">0</div><div class="label">æ€»é¥®æ°´é‡</div></div>
        </div>
        <h3 style="margin:24px 0 12px">ä½“é‡è¶‹åŠ¿</h3>
        <div class="record-card"><div class="info"><div class="title">æœ€æ–°ä½“é‡</div><div class="meta" id="latestWeight">æš‚æ— æ•°æ®</div></div></div>
        <div class="record-card"><div class="info"><div class="title">å¹³å‡ä½“é‡</div><div class="meta" id="avgWeight">æš‚æ— æ•°æ®</div></div></div>
        <div class="record-card"><div class="info"><div class="title">æœ€ä½ä½“é‡</div><div class="meta" id="minWeight">æš‚æ— æ•°æ®</div></div></div>
        <div class="record-card"><div class="info"><div class="title">æœ€é«˜ä½“é‡</div><div class="meta" id="maxWeight">æš‚æ— æ•°æ®</div></div></div>
      </div>
      <div class="page" id="settingsPage">
        <div class="settings-section">
          <h3>å¤–è§‚</h3>
          <div class="theme-options">
            <div class="theme-option active" data-theme="dark" onclick="setTheme('dark')">ğŸŒ™</div>
            <div class="theme-option" data-theme="light" onclick="setTheme('light')">â˜€ï¸</div>
            <div class="theme-option" data-theme="ocean" onclick="setTheme('ocean')">ğŸŒŠ</div>
            <div class="theme-option" data-theme="sunset" onclick="setTheme('sunset')">ğŸŒ…</div>
          </div>
        </div>
        <div class="settings-section">
          <h3>ç›®æ ‡</h3>
          <div class="settings-item" onclick="openGoalModal('water')"><span>æ¯æ—¥é¥®æ°´ç›®æ ‡</span><span class="value" id="waterGoalValue">2000ml</span></div>
          <div class="settings-item" onclick="openGoalModal('calorie')"><span>æ¯æ—¥å¡è·¯é‡Œç›®æ ‡</span><span class="value" id="calorieGoalValue">2000kcal</span></div>
        </div>
        <button class="logout-btn" onclick="logout()">é€€å‡ºç™»å½•</button>
      </div>
      <nav class="bottom-nav">
        <a href="#" class="nav-item active" data-page="home">ğŸ <span>é¦–é¡µ</span></a>
        <a href="#" class="nav-item" data-page="records">ğŸ“<span>è®°å½•</span></a>
        <a href="#" class="nav-item" data-page="stats">ğŸ“Š<span>ç»Ÿè®¡</span></a>
        <a href="#" class="nav-item" data-page="settings">âš™ï¸<span>è®¾ç½®</span></a>
      </nav>
    </div>
  </div>
  <div class="modal-overlay" id="recordModal">
    <div class="modal">
      <div class="modal-header"><h2 id="modalTitle">æ·»åŠ è®°å½•</h2><button class="modal-close" onclick="closeModal()">âœ•</button></div>
      <form id="recordForm">
        <div id="workoutFields" style="display:none">
          <div class="form-group"><label>è¿åŠ¨ç±»å‹</label><select id="workoutType"><option>åŠ›é‡è®­ç»ƒ</option><option>æœ‰æ°§è¿åŠ¨</option><option>ç‘œä¼½</option><option>æ¸¸æ³³</option><option>éª‘è¡Œ</option><option>è·‘æ­¥</option></select></div>
          <div class="form-row"><div class="form-group"><label>æ—¶é•¿(åˆ†é’Ÿ)</label><input type="number" id="workoutDuration"></div><div class="form-group"><label>é‡é‡(kg)</label><input type="number" id="workoutWeight" step="0.5"></div></div>
          <div class="form-row"><div class="form-group"><label>ç»„æ•°</label><input type="number" id="workoutSets"></div><div class="form-group"><label>æ¬¡æ•°</label><input type="number" id="workoutReps"></div></div>
        </div>
        <div id="mealFields" style="display:none">
          <div class="form-group"><label>é¤æ¬¡</label><select id="mealType"><option>æ—©é¤</option><option>åˆé¤</option><option>æ™šé¤</option><option>åŠ é¤</option></select></div>
          <div class="form-group"><label>é£Ÿç‰©</label><input type="text" id="mealFood" required></div>
          <div class="form-row"><div class="form-group"><label>å¡è·¯é‡Œ</label><input type="number" id="mealCalories"></div><div class="form-group"><label>è›‹ç™½è´¨(g)</label><input type="number" id="mealProtein" step="0.1"></div></div>
        </div>
        <div id="weightFields" style="display:none"><div class="form-group"><label>ä½“é‡(kg)</label><input type="number" id="weightValue" step="0.1" required></div></div>
        <div id="waterFields" style="display:none"><div class="form-group"><label>é¥®æ°´é‡(ml)</label><input type="number" id="waterAmount" required></div></div>
        <div class="form-group"><label>æ—¥æœŸ</label><input type="date" id="recordDate"></div>
        <button type="submit" class="btn btn-primary btn-block">ä¿å­˜</button>
      </form>
    </div>
  </div>
  <div class="modal-overlay" id="goalModal">
    <div class="modal">
      <div class="modal-header"><h2 id="goalTitle">è®¾ç½®ç›®æ ‡</h2><button class="modal-close" onclick="closeGoalModal()">âœ•</button></div>
      <form id="goalForm">
        <div class="form-group"><label id="goalLabel">ç›®æ ‡å€¼</label><input type="number" id="goalValue" required></div>
        <button type="submit" class="btn btn-primary btn-block">ä¿å­˜</button>
      </form>
    </div>
  </div>
  <div class="toast" id="toast"></div>
  <script>
    // æ•°æ®å­˜åœ¨ localStorage
    const STORAGE_KEY = 'fitness_data';
    
    let userData = null;
    let currentPage = 'home';
    let currentModalType = '';
    let currentGoalType = '';
    let selectedDate = new Date().toISOString().split('T')[0];
    let allRecords = { workouts: [], meals: [], weights: [], water: [] };
    let settings = { theme: 'dark', daily_water_goal: 2000, daily_calorie_goal: 2000 };

    // ä¿å­˜æ•°æ®
    function saveData() {
      if (userData) {
        localStorage.setItem(STORAGE_KEY, JSON.stringify(userData));
      }
    }

    // åŠ è½½æ•°æ®
    function loadData() {
      const saved = localStorage.getItem(STORAGE_KEY);
      if (saved) {
        userData = JSON.parse(saved);
        settings = userData.settings || { theme: 'dark', daily_water_goal: 2000, daily_calorie_goal: 2000 };
        return true;
      }
      return false;
    }

    // åˆå§‹åŒ–
    document.addEventListener('DOMContentLoaded', () => {
      if (loadData()) {
        showMainApp();
        loadTodayData();
        loadWeekStats();
        loadAllStats();
      } else {
        showAuthPage();
      }
      applyTheme(settings.theme);
      setupEventListeners();
    });

    function setupEventListeners() {
      document.querySelectorAll('.nav-item').forEach(item => {
        item.addEventListener('click', e => { e.preventDefault(); navigateTo(item.dataset.page); });
      });
      document.getElementById('loginForm').addEventListener('submit', handleLogin);
      document.getElementById('registerForm').addEventListener('submit', handleRegister);
      document.getElementById('showRegister').addEventListener('click', e => { e.preventDefault(); document.getElementById('authPage').style.display = 'none'; document.getElementById('registerPage').style.display = 'flex'; });
      document.getElementById('showLogin').addEventListener('click', e => { e.preventDefault(); document.getElementById('registerPage').style.display = 'none'; document.getElementById('authPage').style.display = 'flex'; });
      document.getElementById('settingsBtn').addEventListener('click', () => navigateTo('settings'));
      document.getElementById('recordForm').addEventListener('submit', handleRecordSubmit);
      document.getElementById('goalForm').addEventListener('submit', handleGoalSubmit);
      document.getElementById('recordModal').addEventListener('click', e => { if (e.target.id === 'recordModal') closeModal(); });
      document.getElementById('goalModal').addEventListener('click', e => { if (e.target.id === 'goalModal') closeGoalModal(); });
      document.getElementById('recordDate').value = selectedDate;
    }

    // ç™»å½•
    async function handleLogin(e) {
      e.preventDefault();
      const email = document.getElementById('loginEmail').value;
      if (loadData() && userData && userData.email === email) {
        showMainApp();
        loadTodayData();
        loadWeekStats();
        loadAllStats();
      } else {
        showToast('è´¦å·ä¸å­˜åœ¨ï¼Œè¯·å…ˆæ³¨å†Œ', 'error');
      }
    }

    // æ³¨å†Œ
    async function handleRegister(e) {
      e.preventDefault();
      const email = document.getElementById('registerEmail').value;
      userData = {
        email,
        workouts: [], meals: [], weights: [], water: [],
        settings: { theme: 'dark', daily_water_goal: 2000, daily_calorie_goal: 2000 }
      };
      saveData();
      showMainApp();
      showToast('æ³¨å†ŒæˆåŠŸï¼', 'success');
      loadTodayData();
    }

    function logout() {
      localStorage.removeItem(STORAGE_KEY);
      userData = null;
      location.reload();
    }

    function showAuthPage() {
      document.getElementById('authPage').style.display = 'flex';
      document.getElementById('registerPage').style.display = 'none';
      document.getElementById('mainApp').style.display = 'none';
    }

    function showMainApp() {
      document.getElementById('authPage').style.display = 'none';
      document.getElementById('registerPage').style.display = 'none';
      document.getElementById('mainApp').style.display = 'block';
    }

    function navigateTo(page) {
      currentPage = page;
      document.querySelectorAll('.nav-item').forEach(item => item.classList.toggle('active', item.dataset.page === page));
      document.querySelectorAll('.page').forEach(p => p.classList.toggle('active', p.id === page + 'Page'));
      if (page === 'records') renderDateSelector();
    }

    function loadTodayData() {
      const date = new Date().toISOString().split('T')[0];
      allRecords.workouts = (userData.workouts || []).filter(r => r.date === date);
      allRecords.meals = (userData.meals || []).filter(r => r.date === date);
      allRecords.weights = (userData.weights || []).filter(r => r.date === date);
      allRecords.water = (userData.water || []).filter(r => r.date === date);
      renderTodayRecords();
      renderWaterProgress();
    }

    function loadWeekStats() {
      const today = new Date();
      const weekAgo = new Date(today.getTime() - 7*24*60*60*1000).toISOString().split('T')[0];
      const todayStr = today.toISOString().split('T')[0];
      const weekW = (userData.workouts || []).filter(r => r.date >= weekAgo && r.date <= todayStr);
      const weekM = (userData.meals || []).filter(r => r.date >= weekAgo && r.date <= todayStr);
      const weekWt = (userData.water || []).filter(r => r.date >= weekAgo && r.date <= todayStr);
      const weekWg = (userData.weights || []).filter(r => r.date >= weekAgo && r.date <= todayStr);
      document.getElementById('weekWorkouts').textContent = weekW.length;
      document.getElementById('weekCalories').textContent = weekM.reduce((s,m) => s + (m.calories||0), 0);
      document.getElementById('weekWater').textContent = weekWt.reduce((s,w) => s + w.amount, 0);
      if (weekWg.length) document.getElementById('weekWeight').textContent = (weekWg.reduce((s,w) => s + w.weight, 0) / weekWg.length).toFixed(1) + 'kg';
    }

    function loadAllStats() {
      const workouts = userData.workouts || [];
      const meals = userData.meals || [];
      const water = userData.water || [];
      const weights = userData.weights || [];
      document.getElementById('totalWorkouts').textContent = workouts.length;
      document.getElementById('totalCalories').textContent = meals.reduce((s,m) => s + (m.calories||0), 0);
      document.getElementById('totalProtein').textContent = meals.reduce((s,m) => s + (m.protein||0), 0).toFixed(1) + 'g';
      document.getElementById('totalWater').textContent = water.reduce((s,w) => s + w.amount, 0);
      if (weights.length) {
        const sorted = [...weights].sort((a,b) => new Date(b.date) - new Date(a.date));
        document.getElementById('latestWeight').textContent = sorted[0].weight + 'kg';
        document.getElementById('avgWeight').textContent = (weights.reduce((s,w) => s + w.weight, 0) / weights.length).toFixed(1) + 'kg';
        document.getElementById('minWeight').textContent = Math.min(...weights.map(w => w.weight)) + 'kg';
        document.getElementById('maxWeight').textContent = Math.max(...weights.map(w => w.weight)) + 'kg';
      }
    }

    function renderTodayRecords() {
      const records = [];
      allRecords.workouts.forEach(r => records.push({...r, type:'workout', title:r.type, meta:`${r.duration||0}åˆ†é’Ÿ`}));
      allRecords.meals.forEach(r => records.push({...r, type:'meal', title:r.food, meta:`${r.calories||0}kcal`}));
      allRecords.weights.forEach(r => records.push({...r, type:'weight', title:'ä½“é‡', meta:`${r.weight}kg`}));
      allRecords.water.forEach(r => records.push({...r, type:'water', title:'å–æ°´', meta:`${r.amount}ml`}));
      const html = records.length ? records.map(r => `<div class="record-card"><div class="info"><div class="title">${r.title}</div><div class="meta">${r.meta}</div></div><button class="btn-icon" onclick="deleteRecord('${r.type}',${r.id})">ğŸ—‘ï¸</button></div>`).join('') : '<div class="empty-state"><p>ä»Šå¤©è¿˜æ²¡æœ‰è®°å½•</p></div>';
      document.getElementById('todayRecords').innerHTML = html;
    }

    function renderWaterProgress() {
      const todayWater = allRecords.water.reduce((s,r) => s + r.amount, 0);
      const goal = settings.daily_water_goal || 2000;
      document.getElementById('waterText').textContent = `${todayWater} / ${goal} ml`;
      document.getElementById('waterFill').style.width = Math.min((todayWater/goal)*100, 100) + '%';
    }

    function renderDateSelector() {
      const container = document.getElementById('dateSelector');
      container.innerHTML = [6,5,4,3,2,1,0].map(i => {
        const d = new Date(); d.setDate(d.getDate() - i);
        const ds = d.toISOString().split('T')[0];
        const active = ds === selectedDate ? 'active' : '';
        return `<button class="date-btn ${active}" onclick="selectDate('${ds}')">${d.getMonth()+1}/${d.getDate()}</button>`;
      }).join('');
      loadRecordsForDate(selectedDate);
    }

    function loadRecordsForDate(date) {
      selectedDate = date;
      allRecords.workouts = (userData.workouts || []).filter(r => r.date === date);
      allRecords.meals = (userData.meals || []).filter(r => r.date === date);
      allRecords.weights = (userData.weights || []).filter(r => r.date === date);
      allRecords.water = (userData.water || []).filter(r => r.date === date);
      renderRecordsList();
    }

    function renderRecordsList() {
      const records = [];
      allRecords.workouts.forEach(r => records.push({...r, type:'workout', title:r.type, meta:`${r.duration||0}åˆ†é’Ÿ`}));
      allRecords.meals.forEach(r => records.push({...r, type:'meal', title:r.food, meta:`${r.calories||0}kcal`}));
      allRecords.weights.forEach(r => records.push({...r, type:'weight', title:'ä½“é‡', meta:`${r.weight}kg`}));
      const html = records.length ? records.map(r => `<div class="record-card"><div class="info"><div class="title">${r.title}</div><div class="meta">${r.meta}</div></div><button class="btn-icon" onclick="deleteRecord('${r.type}',${r.id})">ğŸ—‘ï¸</button></div>`).join('') : '<div class="empty-state"><p>æš‚æ— è®°å½•</p></div>';
      document.getElementById('recordsList').innerHTML = html;
    }

    function filterRecords(type) {
      document.querySelectorAll('#recordsPage .date-btn').forEach(b => b.classList.remove('active'));
      event.target.classList.add('active');
      const records = [];
      if (type === 'all' || type === 'workout') allRecords.workouts.forEach(r => records.push({...r, type:'workout', title:r.type, meta:`${r.duration||0}åˆ†é’Ÿ`}));
      if (type === 'all' || type === 'meal') allRecords.meals.forEach(r => records.push({...r, type:'meal', title:r.food, meta:`${r.calories||0}kcal`}));
      if (type === 'all' || type === 'weight') allRecords.weights.forEach(r => records.push({...r, type:'weight', title:'ä½“é‡', meta:`${r.weight}kg`}));
      document.getElementById('recordsList').innerHTML = records.length ? records.map(r => `<div class="record-card"><div class="info"><div class="title">${r.title}</div><div class="meta">${r.meta}</div></div><button class="btn-icon" onclick="deleteRecord('${r.type}',${r.id})">ğŸ—‘ï¸</button></div>`).join('') : '<div class="empty-state"><p>æš‚æ— è®°å½•</p></div>';
    }

    function selectDate(date) { loadRecordsForDate(date); }

    function openModal(type) {
      currentModalType = type;
      const titles = {workout:'æ·»åŠ å¥èº«',meal:'æ·»åŠ é¥®é£Ÿ',weight:'è®°å½•ä½“é‡',water:'è®°å½•å–æ°´'};
      document.getElementById('modalTitle').textContent = titles[type];
      document.getElementById('workoutFields').style.display = type==='workout'?'block':'none';
      document.getElementById('mealFields').style.display = type==='meal'?'block':'none';
      document.getElementById('weightFields').style.display = type==='weight'?'block':'none';
      document.getElementById('waterFields').style.display = type==='water'?'block':'none';
      document.getElementById('recordModal').classList.add('active');
    }

    function closeModal() { document.getElementById('recordModal').classList.remove('active'); document.getElementById('recordForm').reset(); }

    function handleRecordSubmit(e) {
      e.preventDefault();
      const date = document.getElementById('recordDate').value;
      const id = Date.now();
      let record = { id, date };
      
      if (currentModalType === 'workout') {
        record = {...record, type:document.getElementById('workoutType').value, duration:parseInt(document.getElementById('workoutDuration').value)||0, weight:parseFloat(document.getElementById('workoutWeight').value)||0, sets:parseInt(document.getElementById('workoutSets').value)||0, reps:parseInt(document.getElementById('workoutReps').value)||0};
        userData.workouts = userData.workouts || [];
        userData.workouts.push(record);
      } else if (currentModalType === 'meal') {
        record = {...record, type:document.getElementById('mealType').value, food:document.getElementById('mealFood').value, calories:parseInt(document.getElementById('mealCalories').value)||0, protein:parseFloat(document.getElementById('mealProtein').value)||0};
        userData.meals = userData.meals || [];
        userData.meals.push(record);
      } else if (currentModalType === 'weight') {
        record = {...record, weight:parseFloat(document.getElementById('weightValue').value)};
        userData.weights = userData.weights || [];
        userData.weights.push(record);
      } else if (currentModalType === 'water') {
        record = {...record, amount:parseInt(document.getElementById('waterAmount').value)};
        userData.water = userData.water || [];
        userData.water.push(record);
      }
      
      saveData();
      showToast('è®°å½•å·²ä¿å­˜', 'success');
      closeModal();
      loadTodayData();
      loadWeekStats();
      loadAllStats();
    }

    function addWater(amount) {
      const date = new Date().toISOString().split('T')[0];
      userData.water = userData.water || [];
      userData.water.push({ id: Date.now(), date, amount });
      saveData();
      showToast(`å·²æ·»åŠ  ${amount}ml`, 'success');
      loadTodayData();
      loadWeekStats();
    }

    async function deleteRecord(type, id) {
      if (!confirm('ç¡®å®šåˆ é™¤ï¼Ÿ')) return;
      if (type === 'workout') userData.workouts = userData.workouts.filter(r => r.id !== id);
      else if (type === 'meal') userData.meals = userData.meals.filter(r => r.id !== id);
      else if (type === 'weight') userData.weights = userData.weights.filter(r => r.id !== id);
      else if (type === 'water') userData.water = userData.water.filter(r => r.id !== id);
      saveData();
      showToast('å·²åˆ é™¤', 'success');
      loadTodayData();
      loadWeekStats();
      loadAllStats();
      if (currentPage === 'records') loadRecordsForDate(selectedDate);
    }

    function openGoalModal(type) {
      currentGoalType = type;
      const titles = {water:'æ¯æ—¥é¥®æ°´ç›®æ ‡',calorie:'æ¯æ—¥å¡è·¯é‡Œç›®æ ‡'};
      document.getElementById('goalTitle').textContent = titles[type];
      document.getElementById('goalValue').value = type === 'water' ? settings.daily_water_goal : settings.daily_calorie_goal;
      document.getElementById('goalModal').classList.add('active');
    }

    function closeGoalModal() { document.getElementById('goalModal').classList.remove('active'); }

    function handleGoalSubmit(e) {
      e.preventDefault();
      const value = parseInt(document.getElementById('goalValue').value);
      if (currentGoalType === 'water') { settings.daily_water_goal = value; document.getElementById('waterGoalValue').textContent = value + 'ml'; }
      else { settings.daily_calorie_goal = value; document.getElementById('calorieGoalValue').textContent = value + 'kcal'; }
      userData.settings = settings;
      saveData();
      showToast('ç›®æ ‡å·²æ›´æ–°', 'success');
      closeGoalModal();
      loadTodayData();
    }

    function setTheme(theme) {
      applyTheme(theme);
      settings.theme = theme;
      userData.settings = settings;
      saveData();
      document.querySelectorAll('.theme-option').forEach(o => o.classList.toggle('active', o.dataset.theme === theme));
    }

    function applyTheme(theme) { document.body.className = 'theme-' + theme; }

    function showToast(msg, type='') {
      const t = document.getElementById('toast');
      t.textContent = msg;
      t.className = 'toast ' + type + ' show';
      setTimeout(() => t.classList.remove('show'), 2500);
    }
  </script>
</body>
</html>
